generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "mysql"
}

// User roles enum
enum Role {
  admin
  employee
}

enum WithGST {
  inclusive
  exclusive
}

// User model - stores all user information
model User {
  id             Int      @id @default(autoincrement())
  name           String   @db.VarChar(100)
  email          String   @unique @db.VarChar(255)
  phone          String   @db.VarChar(20)
  password       String   @db.VarChar(255)
  role           Role     @default(employee)
  loginStartTime String?  @map("login_start_time") @db.VarChar(8) // TIME stored as string HH:MM:SS
  loginEndTime   String?  @map("login_end_time") @db.VarChar(8) // TIME stored as string HH:MM:SS
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.DateTime(0)

  // Relations
  loginSessions LoginSession[]

  assignedOrders Order[] @relation("AssignedOrders")
  createdOrders  Order[] @relation("CreatedOrders")

  @@map("users")
}

// LoginSession model - tracks user login history
model LoginSession {
  id         Int       @id @default(autoincrement())
  userId     Int       @map("user_id")
  loginTime  DateTime  @default(now()) @map("login_time") @db.DateTime(0)
  logoutTime DateTime? @map("logout_time") @db.DateTime(0)
  ipAddress  String?   @map("ip_address") @db.VarChar(45)
  userAgent  String?   @map("user_agent") @db.Text
  isValid    Boolean   @default(true) @map("is_valid")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("login_sessions")
}

// Order status enum
enum OrderStatus {
  pending
  confirmed
  packed
  shipped
  out_for_delivery
  delivered
  cancelled
  rto_initiated
  rto_received
}

// Payment status enum
enum PaymentStatus {
  pending
  paid
  failed
  refunded
}

// Orders table (main order record)
model Order {
  id            Int     @id @default(autoincrement())
  orderNumber   String  @unique @db.VarChar(50)
  customerName  String  @db.VarChar(100)
  customerPhone String  @db.VarChar(20)
  customerEmail String? @db.VarChar(255)

  status        OrderStatus   @default(pending)
  paymentStatus PaymentStatus @default(pending)

  totalAmount     Decimal @db.Decimal(10, 2)
  shippingAddress String  @db.Text

  assignedToId Int? @map("assigned_to_id") // employee
  createdById  Int  @map("created_by_id") // admin/employee

  createdAt DateTime @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt DateTime @updatedAt @map("updated_at") @db.DateTime(0)

  // Relations
  items      OrderItem[]
  assignedTo User?            @relation("AssignedOrders", fields: [assignedToId], references: [id])
  createdBy  User             @relation("CreatedOrders", fields: [createdById], references: [id])
  statusLogs OrderStatusLog[]
  rto        RTOOrder?

  deliveryPartner  String?
  isVerified       Boolean  @default(false)
  trackingId       String?
  pipelineRemark   String?
  liveLocation     String?
  deliveryStatus   String?
  alternateContact String?
  OkOrderStatus    String?
  notConfirmStatus String?
  courierCharges   Decimal?
  advance          Decimal?
  orderRemark      String?
  withGST          WithGST?
  paymentType      String?
  discount         Decimal?
  stateCode        String?
  gstRate          String?

  @@index([status])
  @@index([assignedToId])
  @@map("orders")
}

// Individual products inside an order
model OrderItem {
  id           Int     @id @default(autoincrement())
  orderId      Int     @map("order_id")
  productName  String  @db.VarChar(255)
  quantity     Int
  price        Decimal @db.Decimal(10, 2)
  weight       Decimal @db.Decimal(5, 2)
  weighingUnit String  @db.VarChar(5)

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@map("order_items")
}

// Order status history (audit trail)
model OrderStatusLog {
  id        Int         @id @default(autoincrement())
  orderId   Int         @map("order_id")
  status    OrderStatus
  note      String?     @db.Text
  createdAt DateTime    @default(now()) @map("created_at") @db.DateTime(0)

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@map("order_status_logs")
}

// RTO (Return To Origin) details
model RTOOrder {
  id         Int       @id @default(autoincrement())
  orderId    Int       @unique @map("order_id")
  reason     String    @db.Text
  receivedAt DateTime? @map("received_at") @db.DateTime(0)
  createdAt  DateTime  @default(now()) @map("created_at") @db.DateTime(0)

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("rto_orders")
}